<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Filtrar Transformadores com Taxa LC </title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 40px auto;
      background: linear-gradient(to bottom right, #f7f7f7, #e1e1e1);
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
      color: #34495e;
    }
    input, button {
      padding: 10px;
      width: 100%;
      margin-top: 8px;
      border-radius: 5px;
      border: 1px solid #bbb;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      background-color: #2980b9;
      color: white;
      border: none;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) { background-color: #3498db; }
    button:disabled { background-color: #95a5a6; cursor: not-allowed; }
    #resultado {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      min-height: 80px;
    }
    .item {
      padding: 15px;
      margin-bottom: 10px;
      background-color: #fdfdfd;
      border-left: 6px solid #2980b9;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.05);
    }
    .item:last-child { margin-bottom: 0; }
    strong { color: #2c3e50; }
  </style>
</head>
<body>

<h1>Filtrar Transformadores com Taxa LC Garantida</h1>

<label for="csvMeta">1) CSV de Metadados:</label>
<input type="file" id="csvMeta" accept=".csv" />

<label for="csvSerie">2) CSV de Séries (LC_3_8 + DataHora):</label>
<input type="file" id="csvSerie" accept=".csv" />

<label for="potenciaInput">Potência (ex: 140):</label>
<input type="text" id="potenciaInput" placeholder="Potência" disabled />

<label for="tensaoInput">Tensão (ex: 240.5):</label>
<input type="text" id="tensaoInput" placeholder="Tensão" disabled />

<button id="btnFiltrar" disabled>Procurar</button>

<div id="resultado">Carrega primeiro os dois ficheiros CSV.</div>

<script>
let dadosMeta = [], dadosSerie = [];

function checkReady() {
  const ok = Array.isArray(dadosMeta) && dadosMeta.length > 0 &&
             Array.isArray(dadosSerie) && dadosSerie.length > 0;
  ['potenciaInput', 'tensaoInput', 'btnFiltrar'].forEach(id =>
    document.getElementById(id).disabled = !ok
  );
  if (ok) {
    document.getElementById('resultado').textContent = 'CSV carregados. Insere potência e tensão.';
  }
}

function carregarCSV(inputId, targetArray) {
  document.getElementById(inputId).addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      Papa.parse(ev.target.result, {
        header: true,
        skipEmptyLines: true,
        complete: res => {
          if (res.errors.length > 0) {
            console.error(`Erros no CSV ${inputId}:`, res.errors);
            document.getElementById('resultado').innerHTML =
              `<div class="item">Erro ao ler CSV ${inputId}: ${res.errors.map(err => err.message).join(', ')}</div>`;
            return;
          }
          // Limpar "NULL" para string vazia
          const dadosLimpos = res.data.map(linha => {
            const novaLinha = {};
            for (const key in linha) {
              novaLinha[key] = linha[key] === "NULL" ? "" : linha[key];
            }
            return novaLinha;
          });

          targetArray.length = 0;
          targetArray.push(...dadosLimpos);
          console.log(`CSV ${inputId} carregado com ${dadosLimpos.length} linhas.`);
          checkReady();
        },
        error: err => {
          document.getElementById('resultado').innerHTML =
            `<div class="item">Erro ao ler CSV: ${err.message}</div>`;
          console.error(err);
        }
      });
    };
    reader.readAsText(f);
  });
}

carregarCSV('csvMeta', dadosMeta);
carregarCSV('csvSerie', dadosSerie);

function parseNum(v) {
  return parseFloat((v || '').toString().replace(',', '.').trim());
}

function fmt(v, dec = 2) {
  return isNaN(v) ? '' : v.toFixed(dec);
}

function calcLC(id, massaiKg) {
  const linhas = dadosSerie.filter(r =>
    (r.id_secagenscore || '').trim() === id &&
    r.LC_3_8 && r.DataHora
  );

  const lc = linhas.map(r => parseNum(r.LC_3_8)).sort((a, b) => a - b);
  const difLC = lc.length ? lc[lc.length - 1] - lc[0] : NaN;

  const ts = linhas
    .map(r => new Date(r.DataHora).getTime())
    .filter(t => !isNaN(t))
    .sort((a, b) => a - b);
  const dur = ts.length ? (ts[ts.length - 1] - ts[0]) / 36e5 : NaN;

  const ton = parseNum(massaiKg) / 1000;

  const taxa = (difLC) / (dur * ton);

  return { difLC, dur, taxa };
}

document.getElementById('btnFiltrar').addEventListener('click', () => {
  const pot = document.getElementById('potenciaInput').value.trim();
  const ten = document.getElementById('tensaoInput').value.trim();
  const out = document.getElementById('resultado');

  if (!pot || !ten) {
    out.innerHTML = `<div class="item">Preenche ambos os campos.</div>`;
    return;
  }

  const encontrados = dadosMeta.filter(r =>
    (r.potencia || '').trim() === pot &&
    (r.tensao || '').trim() === ten
  );

  if (!encontrados.length) {
    out.innerHTML = `<div class="item">Nenhum transformador encontrado.</div>`;
    return;
  }

  let html = `<strong>${encontrados.length} transformador(es):</strong><br>`;
  encontrados.forEach((m, i) => {
    const id = (m.id_secagenscore || '').trim();
    const stats = calcLC(id, m.massai);
    const mTon = parseNum(m.massai) / 1000;
    html += `
      <div class="item">
        <strong>#${i + 1} — ID:</strong> ${id}<br>
        <strong>Projecto:</strong> ${m.subprojecto || 'N/A'}<br>
        <strong>Massai:</strong> ${fmt(mTon, 3)} t<br>
        <strong>Δ LC:</strong> ${fmt(stats.difLC, 3)}<br>
        <strong>Duração (h):</strong> ${fmt(stats.dur)}<br>
        <strong>Taxa de remoção de água:</strong> ${fmt(stats.taxa)}
      </div>
    `;
  });
  out.innerHTML = html;
});
</script>

</body>
</html>
