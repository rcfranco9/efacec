<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>Filtragem de Transformadores com Índices PF/RF - Completo</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  /* mantém teu estilo original aqui */
</style>
</head>
<body>

<h1>Filtragem de Transformadores com Índices PF/RF</h1>

<label for="csvMeta">1) CSV1 (Meta):</label>
<input type="file" id="csvMeta" accept=".csv" />

<label for="csvSerie">2) CSV2 (Série):</label>
<input type="file" id="csvSerie" accept=".csv" />

<label for="csv3">3) CSV3 (PFxTAquec, RFxTAquec, PFxPRem, RFxPRem):</label>
<input type="file" id="csv3" accept=".csv" />

<label for="potenciaInput">Potência (ex: 140):</label>
<input type="text" id="potenciaInput" placeholder="Potência" disabled />

<label for="tensaoInput">Tensão (ex: 240.5):</label>
<input type="text" id="tensaoInput" placeholder="Tensão" disabled />

<button id="btnFiltrar" disabled>Procurar</button>

<div id="resultado">Carrega primeiro os três ficheiros CSV.</div>

<div style="margin-top: 30px;">
  <h3>Taxas de Remoção de Água (últimas 18h em blocos de 3h)</h3>
  <canvas id="graficoTaxasRemocao" width="600" height="300"></canvas>
</div>

<button id="btnExportarPDF" style="display:none; margin-top: 20px;">Exportar PDF</button>

<script>
  let dadosMeta = [], dadosSerie = [], dadosPF = [];
  let meuGrafico = null;

  // --- Funções auxiliares (formatNum, parseNum, checkReady, etc.) ---

  function formatNum(v, dec = 3) {
    const n = parseFloat(v);
    if (isNaN(n) || n === 0) return 'N/A';
    return parseFloat(n.toFixed(dec)).toString();
  }

  function parseNum(v) {
    const n = parseFloat((v||'').toString().replace(',', '.').trim());
    return isNaN(n) ? NaN : n;
  }

  function checkReady() {
    const ok = dadosMeta.length && dadosSerie.length && dadosPF.length;
    ['potenciaInput','tensaoInput','btnFiltrar'].forEach(id => {
      document.getElementById(id).disabled = !ok;
    });
    if (ok) {
      document.getElementById('resultado').textContent = 'CSV carregados. Insere potência e tensão.';
    } else {
      document.getElementById('resultado').textContent = 'Carrega os três ficheiros CSV.';
    }
  }

  // --- Funções para cálculos ---

  function calcLC(id, massaiKg) {
    const linhas = dadosSerie.filter(r => (r.id_secagenscore||'').trim() === id && r.LC_3_8 && r.DataHora);
    const registos = linhas.map(r => ({ valor: parseNum(r.LC_3_8), ts: new Date(r.DataHora).getTime() }))
                          .filter(r => !isNaN(r.ts) && !isNaN(r.valor));
    if (registos.length < 2) return { difLC: 0, dur: 1, taxa: 0, delta10h: 0, taxa10h: 0 };
    registos.sort((a,b) => a.ts - b.ts);
    const ultimo = registos[registos.length - 1];
    const alvoTS = ultimo.ts - 10 * 3600000;
    let anterior10h = registos[0];
    for (let i = registos.length - 1; i >= 0; i--) {
      if (registos[i].ts <= alvoTS) {
        anterior10h = registos[i];
        break;
      }
    }
    const delta10h = +(ultimo.valor - anterior10h.valor).toFixed(3);
    const dur = +(((ultimo.ts - registos[0].ts) / 36e5)).toFixed(2) || 1;
    const ton = parseNum(massaiKg) / 1000 || 1;
    const difLC = +ultimo.valor.toFixed(3);
    const taxa = +(difLC / (dur * ton)).toFixed(2);
    const taxa10h = +(delta10h / (10 * ton)).toFixed(2);
    return { difLC, dur, taxa, delta10h, taxa10h };
  }

  function maxTEfromSerie(id) {
    const colunas = ['TE_5_4_1','TE_5_4_2','TE_5_4_3','TE_5_4_4','TE_5_4_5','TE_5_4_6'];
    const valores = [];
    dadosSerie.filter(r => (r.id_secagenscore || '').trim() === id)
      .forEach(linha => colunas.forEach(col => {
        const val = parseNum(linha[col]);
        if (!isNaN(val) && val > 0 && val <= 140) valores.push(val);
      }));
    return valores.length > 0 ? Math.max(...valores).toFixed(2) : 'N/A';
  }

  function minPE(id, coluna) {
    const valores = dadosSerie.filter(r => (r.id_secagenscore || '').trim() === id)
      .map(r => parseNum(r[coluna])).filter(v => !isNaN(v) && v > 0.1);
    return valores.length ? Math.min(...valores).toFixed(3) : 'N/A';
  }

  function pegaDadosPF(id) {
    const reg = dadosPF.find(r => (r.id_secagenscore||'').trim() === id);
    if (!reg) return null;
    const PFxTAquec = [], RFxTAquec = [], PFxPRem = [], RFxPRem = [];
    for(let n=1; n<=6; n++) {
      PFxTAquec.push(parseNum(reg[`PF${n}TAquec`]));
      RFxTAquec.push(parseNum(reg[`RF${n}TAquec`]));
      PFxPRem.push(parseNum(reg[`PF${n}PRem`]));
      RFxPRem.push(parseNum(reg[`RF${n}PRem`]));
    }
    return { PFxTAquec, RFxTAquec, PFxPRem, RFxPRem };
  }

  function calculaIndiceTemperatura(pf, rf) {
    if (isNaN(pf) || isNaN(rf)) return 'N/A';
    const diff = rf - pf;
    if (diff >= 5) return '100%';
    if (diff <= -5) return '0%';
    const proporcao = (diff + 5) / 10;
    return `${Math.round(proporcao * 100)}%`;
  }

  function calculaIndicePressao(pf, rf) {
    if (isNaN(pf) || isNaN(rf)) return 'N/A';
    const diff = rf - pf;
    if (diff >= 5) return '0%';
    if (diff <= -5) return '100%';
    if (diff === 0) return '50%';
    const proporcao = (5 - diff) / 10;
    return `${Math.round(proporcao * 100)}%`;
  }

  function calculaTaxasRemocaoBlocos(id, massaiKg) {
    const registos = dadosSerie
      .filter(r => (r.id_secagenscore||'').trim() === id && r.LC_3_8 && r.DataHora)
      .map(r => ({ valor: parseNum(r.LC_3_8), ts: new Date(r.DataHora).getTime() }))
      .filter(r => !isNaN(r.ts) && !isNaN(r.valor));
    if (registos.length === 0) return Array(6).fill('N/A');
    registos.sort((a,b) => a.ts - b.ts);
    const now = registos[registos.length - 1].ts;
    const ton = parseNum(massaiKg) / 1000 || 1;
    const blocosTaxas = [];
    for(let i=5; i>=0; i--) {
      const fim = now - i * 3 * 3600000;
      const inicio = fim - 3 * 3600000;
      const bloco = registos.filter(r => r.ts >= inicio && r.ts <= fim);
      if (bloco.length < 2) {
        blocosTaxas.push('N/A');
        continue;
      }
      const valInicio = bloco[0].valor;
      const valFim = bloco[bloco.length - 1].valor;
      const deltaLC = valFim - valInicio;
      const taxa = deltaLC / (3 * ton);
      blocosTaxas.push(taxa.toFixed(3));
    }
    return blocosTaxas;
  }

  function desenharGraficoTaxasRemocao(taxas) {
    const ctx = document.getElementById('graficoTaxasRemocao').getContext('2d');
    if (meuGrafico) meuGrafico.destroy();
    const pontos = taxas.map((t,i) => ({ x: i, y: isNaN(t) ? null : parseFloat(t) }));
    meuGrafico = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Taxas de remoção (L/(h*t))',
          data: pontos,
          backgroundColor: 'rgba(255, 99, 132, 0.7)',
          pointRadius: 6,
          showLine: true,
          borderColor: 'rgba(255, 99, 132, 0.7)',
        }]
      },
      options: {
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            ticks: {
              callback: val => {
                const labels = ['15-18h atrás', '12-15h atrás', '9-12h atrás', '6-9h atrás', '3-6h atrás', '0-3h atrás'];
                return labels[val] || val;
              }
            },
            min: 0,
            max: 5
          },
          y: { beginAtZero: true }
        }
      }
    });
  }

  // --- Eventos de carregamento dos CSVs e habilitação dos inputs ---
  document.getElementById('csvMeta').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => Papa.parse(ev.target.result, {
      header:true, skipEmptyLines:true,
      complete: res => { dadosMeta = res.data; checkReady(); }
    });
    r.readAsText(f);
  });
  document.getElementById('csvSerie').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => Papa.parse(ev.target.result, {
      header:true, skipEmptyLines:true,
      complete: res => { dadosSerie = res.data; checkReady(); }
    });
    r.readAsText(f);
  });
  document.getElementById('csv3').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => Papa.parse(ev.target.result, {
      header:true, skipEmptyLines:true,
      complete: res => { dadosPF = res.data; checkReady(); }
    });
    r.readAsText(f);
  });

  document.getElementById('btnFiltrar').addEventListener('click', () => {
    const potRaw = document.getElementById('potenciaInput').value.trim();
    const tenRaw = document.getElementById('tensaoInput').value.trim();

    const pot = potRaw.replace(',', '.');
    const ten = tenRaw.replace(',', '.');

    const encontrados = dadosMeta.filter(r => {
      const potencia = (r.potencia || '').trim().replace(',', '.');
      const tensao = (r.tensao || '').trim().replace(',', '.');
      return potencia === pot && tensao === ten;
    });

    const out = document.getElementById('resultado');
    if (encontrados.length === 0) {
      out.textContent = 'Nenhum transformador encontrado com esses valores de potência e tensão.';
      document.getElementById('btnExportarPDF').style.display = 'none';
      return;
    }

    let html = `<strong>${encontrados.length} transformador(es) encontrado(s):</strong>`;

    encontrados.forEach((m,i) => {
      const id = (m.id_secagenscore||'').trim();
      const stats = calcLC(id, m.massai);
      const mTon = (parseNum(m.massai)/1000).toFixed(3);
      const teMax = maxTEfromSerie(id);
      const pe417 = minPE(id, 'PE_4_17');
      const pe551 = minPE(id, 'PE_5_5_1');

      const dadosPFRF = pegaDadosPF(id);
      const taxasRemocao = calculaTaxasRemocaoBlocos(id, m.massai);

      html += `<div class="transformador-dados">
        <strong>#${i+1} — ID:</strong> ${id}<br>
        <strong>Projecto:</strong> ${m.subprojecto || 'N/A'}<br>
        <strong>Potência:</strong> ${m.potencia} kVA<br>
        <strong>Tensão:</strong> ${m.tensao} V<br>
        <strong>Massa (kg):</strong> ${m.massai}<br>
        <ul>
          <li><strong>Duração (h):</strong> ${stats.dur}</li>
          <li><strong>LC 3.8 (%):</strong> ${formatNum(stats.difLC)}</li>
          <li><strong>Taxa total LC (L/(h*t)):</strong> ${formatNum(stats.taxa)}</li>
          <li><strong>Delta 10h (%):</strong> ${formatNum(stats.delta10h)}</li>
          <li><strong>Taxa 10h LC (L/(h*t)):</strong> ${formatNum(stats.taxa10h)}</li>
          <li><strong>Máx TE 5_4_x:</strong> ${teMax}</li>
          <li><strong>Mín PE 4_17:</strong> ${pe417}</li>
          <li><strong>Mín PE 5_5_1:</strong> ${pe551}</li>
        </ul>`;

      if (dadosPFRF) {
        html += `<strong>Índices PFxTAquec / RFxTAquec</strong><br><table><thead><tr><th>Pos</th><th>PF</th><th>RF</th><th>Índice Temperatura</th></tr></thead><tbody>`;
        for(let n=0; n<6; n++) {
          const pf = dadosPFRF.PFxTAquec[n];
          const rf = dadosPFRF.RFxTAquec[n];
          const idx = calculaIndiceTemperatura(pf, rf);
          html += `<tr><td>${n+1}</td><td>${formatNum(pf)}</td><td>${formatNum(rf)}</td><td>${idx}</td></tr>`;
        }
        html += `</tbody></table>`;

        html += `<strong>Índices PFxPRem / RFxPRem</strong><br><table><thead><tr><th>Pos</th><th>PF</th><th>RF</th><th>Índice Pressão</th></tr></thead><tbody>`;
        for(let n=0; n<6; n++) {
          const pf = dadosPFRF.PFxPRem[n];
          const rf = dadosPFRF.RFxPRem[n];
          const idx = calculaIndicePressao(pf, rf);
          html += `<tr><td>${n+1}</td><td>${formatNum(pf)}</td><td>${formatNum(rf)}</td><td>${idx}</td></tr>`;
        }
        html += `</tbody></table>`;
      }

      html += `<strong>Taxas de Remoção (L/(h*t)) em blocos de 3h nas últimas 18h:</strong><br><ul>`;
      taxasRemocao.forEach((tx,i) => {
        html += `<li>${['15-18h','12-15h','9-12h','6-9h','3-6h','0-3h'][i]} atrás: ${tx}</li>`;
      });
      html += `</ul></div>`;
      
      desenharGraficoTaxasRemocao(taxasRemocao);
    });

    out.innerHTML = html;
    document.getElementById('btnExportarPDF').style.display = 'inline-block';
  });

  // --- Exportar para PDF ---
  document.getElementById('btnExportarPDF').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    html2canvas(document.getElementById('resultado')).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('transformadores.pdf');
    });
  });
</script>
</body>
</html>

