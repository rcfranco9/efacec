<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Filtragem e Comparação de Transformadores</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 40px auto;
      background: linear-gradient(to bottom right, #f7f7f7, #e1e1e1);
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
      color: #34495e;
    }
    input, button {
      padding: 10px;
      width: 100%;
      margin-top: 8px;
      border-radius: 5px;
      border: 1px solid #bbb;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      background-color: #2980b9;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) {
      background-color: #3498db;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    #resultado {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      min-height: 100px;
    }
    .transformador-dados {
      background: #fdfdfd;
      border: 1px solid #ccc;
      padding: 15px 20px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: background 0.3s;
    }
    .transformador-dados:hover {
      background: #f0f8ff;
    }
    .transformador-dados strong {
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #2980b9;
      color: white;
    }
  </style>
</head>
<body>

  <h1>Filtragem e Comparação de Transformadores</h1>

  <label>1) CSV Meta (dados dos transformadores):</label>
  <input type="file" id="csvMeta" accept=".csv" />

  <label>2) CSV Série (dados de medições):</label>
  <input type="file" id="csvSerie" accept=".csv" />

  <label>3) CSV Parâmetros PF e RF:</label>
  <input type="file" id="csvPfRf" accept=".csv" />

  <label>Potência (kVA):</label>
  <input type="text" id="potenciaInput" disabled />

  <label>Tensão (kV):</label>
  <input type="text" id="tensaoInput" disabled />

  <button id="btnFiltrar" disabled>Procurar Transformadores</button>

  <div id="resultado">Carrega os três ficheiros CSV e insere potência e tensão para procurar.</div>
  <button id="btnExportarPDF" style="display:none; margin-top:15px;">Exportar PDF</button>

<script>
  let dadosMeta = [], dadosSerie = [], dadosPfRf = [];

  function parseNum(v) {
    const n = parseFloat((v||'').toString().replace(',', '.').trim());
    return isNaN(n) ? NaN : n;
  }

  // Carregar CSVs
  document.getElementById('csvMeta').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    Papa.parse(f, {
      header: true, skipEmptyLines: true,
      complete: res => {
        dadosMeta = res.data;
        verificarReady();
      }
    });
  });
  document.getElementById('csvSerie').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    Papa.parse(f, {
      header: true, skipEmptyLines: true,
      complete: res => {
        dadosSerie = res.data;
        verificarReady();
      }
    });
  });
  document.getElementById('csvPfRf').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    Papa.parse(f, {
      header: true, skipEmptyLines: true,
      complete: res => {
        dadosPfRf = res.data;
        verificarReady();
      }
    });
  });

  function verificarReady() {
    const ready = dadosMeta.length > 0 && dadosSerie.length > 0 && dadosPfRf.length > 0;
    document.getElementById('potenciaInput').disabled = !ready;
    document.getElementById('tensaoInput').disabled = !ready;
    document.getElementById('btnFiltrar').disabled = !ready;
    if (ready) {
      document.getElementById('resultado').textContent = 'CSV carregados. Introduz potência e tensão para procurar.';
    }
  }

  function calcTaxa(id, massaKg) {
    const serie = dadosSerie
      .filter(r => (r.id_secagenscore || '').trim() === id && r.LC_3_8 && r.DataHora)
      .map(r => ({
        ts: new Date(r.DataHora.replace(' ', 'T')).getTime(),
        lc: parseNum(r.LC_3_8)
      }))
      .filter(r => !isNaN(r.ts) && !isNaN(r.lc))
      .sort((a,b) => a.ts - b.ts);

    if (serie.length < 2) return null;

    const ton = (parseNum(massaKg) / 1000) || 1;
    const ultimo = serie[serie.length - 1];
    const alvo = ultimo.ts - 10 * 3600 * 1000;
    const anterior = serie.slice().reverse().find(r => r.ts <= alvo) || serie[0];

    const delta10h = +(ultimo.lc - anterior.lc).toFixed(3);
    const duracao = (ultimo.ts - serie[0].ts) / 3600000;
    const deltaTotal = +ultimo.lc.toFixed(3);

    const taxa10h = +(delta10h / (10 * ton)).toFixed(4);
    const taxaTotal = +(deltaTotal / (duracao * ton)).toFixed(4);

    return { delta10h, taxa10h, deltaTotal, taxaTotal, duracao };
  }

  function maxTEfromSerie(id) {
    const cols = ['TE_5_4_1','TE_5_4_2','TE_5_4_3','TE_5_4_4','TE_5_4_5','TE_5_4_6'];
    const valores = [];
    dadosSerie.filter(r => (r.id_secagenscore || '').trim() === id)
      .forEach(linha => {
        cols.forEach(col => {
          const v = parseNum(linha[col]);
          if (!isNaN(v) && v > 0 && v <= 140) valores.push(v);
        });
      });
    return valores.length ? Math.max(...valores) : null;
  }

  function minPE(id, col) {
    const vals = dadosSerie.filter(r => (r.id_secagenscore || '').trim() === id)
      .map(r => parseNum(r[col])).filter(v => !isNaN(v) && v > 0.1);
    return vals.length ? Math.min(...vals) : null;
  }

  function calcularIndice(pf, rf) {
    const delta = 5;
    if (rf >= pf + delta) return 100;
    if (rf <= pf - delta) return 0;
    return Math.round(((rf - (pf - delta)) / (2 * delta)) * 100);
  }

  function formatNum(v, dec=3) {
    if (v === null || v === undefined || isNaN(v) || v === 0) return 'N/A';
    return parseFloat(v).toFixed(dec);
  }

  document.getElementById('btnFiltrar').addEventListener('click', () => {
    const pot = document.getElementById('potenciaInput').value.trim();
    const ten = document.getElementById('tensaoInput').value.trim();
    const out = document.getElementById('resultado');
    if (!pot || !ten) {
      out.innerHTML = '<p style="color:red;">Preenche potência e tensão.</p>';
      return;
    }

    // Filtro por potência e tensão exatos (trim e toLower não usados pois são números, apenas trim)
    const encontrados = dadosMeta.filter(r =>
      (r.potencia||'').trim() === pot && (r.tensao||'').trim() === ten
    );

    if (!encontrados.length) {
      out.innerHTML = '<p style="color:red;">Nenhum transformador encontrado para esses valores.</p>';
      return;
    }

    // Gerar HTML para cada transformador encontrado
    let html = `<strong>${encontrados.length} transformador(es) encontrados para Potência=${pot} kVA e Tensão=${ten} kV:</strong><br>`;

    encontrados.forEach((m, i) => {
      const id = (m.id_secagenscore || '').trim();
      if (!id) return;

      const taxa = calcTaxa(id, m.massai);
      const teMax = maxTEfromSerie(id);
      const pe417 = minPE(id, 'PE_4_17');
      const pe551 = minPE(id, 'PE_5_5_1');

      const pfRf = dadosPfRf.find(r => (r.id_secagenscore || '').trim() === id);
      const pf = pfRf ? parseNum(pfRf['PF1PRem']) : null;
      const rf = pfRf ? parseNum(pfRf['RF1PRem']) : null;
      const indice = (pf !== null && rf !== null) ? calcularIndice(pf, rf) : 'N/A';

      html += `
        <div class="transformador-dados">
          <h3>#${i+1} - ID: ${id}</h3>
          <p><strong>Subprojecto:</strong> ${m.subprojecto || 'N/A'}</p>
          <p><strong>Massa isolantes:</strong> ${formatNum(parseNum(m.massai),3)} kg</p>

          <table>
            <thead>
              <tr><th>Parâmetro</th><th>Valor</th><th>Unidade</th></tr>
            </thead>
            <tbody>
              <tr><td>Duração total</td><td>${taxa ? formatNum(taxa.duracao,2) : 'N/A'}</td><td>h</td></tr>
              <tr><td>Quantidade água removida</td><td>${taxa ? formatNum(taxa.deltaTotal) : 'N/A'}</td><td>L</td></tr>
              <tr><td>Taxa remoção total</td><td>${taxa ? formatNum(taxa.taxaTotal) : 'N/A'}</td><td>L/(h*t)</td></tr>
              <tr><td>Taxa remoção últimas 10h</td><td>${taxa ? formatNum(taxa.taxa10h) : 'N/A'}</td><td>L/(h*t)</td></tr>
              <tr><td>Maior temperatura sondas</td><td>${formatNum(teMax,2)}</td><td>ºC</td></tr>
              <tr><td>Menor pressão PE_4_17</td><td>${formatNum(pe417,3)}</td><td>mbar</td></tr>
              <tr><td>Menor pressão PE_5_5_1</td><td>${formatNum(pe551,3)}</td><td>mbar</td></tr>
              <tr><td>PF1PRem</td><td>${pf !== null ? pf.toFixed(3) : 'N/A'}</td><td></td></tr>
              <tr><td>RF1PRem</td><td>${rf !== null ? rf.toFixed(3) : 'N/A'}</td><td></td></tr>
              <tr><td>Índice desempenho</td><td>${indice !== 'N/A' ? indice + '%' : 'N/A'}</td><td></td></tr>
            </tbody>
          </table>
        </div>
      `;
    });

    out.innerHTML = html;
    document.getElementById('btnExportarPDF').style.display = encontrados.length > 0 ? 'inline-block' : 'none';
  });

  // Exportar PDF
  document.getElementById('btnExportarPDF').addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'px', format: 'a4', orientation: 'portrait' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let cursorY = 20;
    const transformadores = Array.from(document.querySelectorAll('.transformador-dados'));
    for (let i = 0; i < transformadores.length; i++) {
      const el = transformadores[i];
      await html2canvas(el, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const imgWidth = pageWidth - 40;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        if (cursorY + imgHeight > pageHeight - 20) {
          doc.addPage();
          cursorY = 20;
        }
        doc.addImage(imgData, 'PNG', 20, cursorY, imgWidth, imgHeight);
        cursorY += imgHeight + 10;
      });
    }
    const pot = document.getElementById('potenciaInput').value.trim().replace(/\s+/g, '_');
    const ten = document.getElementById('tensaoInput').value.trim().replace(/\s+/g, '_');
    doc.save(`Transformadores_${pot || 'X'}kVA_${ten || 'Y'}kV.pdf`);
  });
</script>

</body>
</html>
