<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Filtrar Transformadores com Taxa LC</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* Mesmo estilo anterior */
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 40px auto;
      background: linear-gradient(to bottom right, #f7f7f7, #e1e1e1);
      padding: 30px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: 600;
      color: #34495e;
    }
    input, button {
      padding: 10px;
      width: 100%;
      margin-top: 8px;
      border-radius: 5px;
      border: 1px solid #bbb;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      background-color: #2980b9;
      color: white;
      border: none;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover:not(:disabled) { background-color: #3498db; }
    button:disabled { background-color: #95a5a6; cursor: not-allowed; }
    #resultado {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      min-height: 80px;
    }
    .item {
      padding: 15px;
      margin-bottom: 10px;
      background-color: #fdfdfd;
      border-left: 6px solid #2980b9;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.05);
    }
    .item:last-child { margin-bottom: 0; }
    strong { color: #2c3e50; }
  </style>
</head>
<body>

<h1>Filtrar Transformadores com Taxa LC</h1>

<label for="csvMeta">CSV de Metadados:</label>
<input type="file" id="csvMeta" accept=".csv" />

<label for="csvSerie">CSV de Séries (LC_3_8 + DataHora):</label>
<input type="file" id="csvSerie" accept=".csv" />

<label for="potenciaInput">Potência (ex: 140):</label>
<input type="text" id="potenciaInput" placeholder="Potência" disabled />

<label for="tensaoInput">Tensão (ex: 240.5):</label>
<input type="text" id="tensaoInput" placeholder="Tensão" disabled />

<button id="btnFiltrar" disabled>Procurar</button>

<div id="resultado">Carrega primeiro os dois ficheiros CSV.</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dadosMeta = [], dadosSerie = [];

  function checkReady() {
    const ok = dadosMeta.length > 0 && dadosSerie.length > 0;
    ['potenciaInput', 'tensaoInput', 'btnFiltrar'].forEach(id =>
      document.getElementById(id).disabled = !ok
    );
    if (ok) {
      document.getElementById('resultado').textContent = 'CSV carregados. Insere potência e tensão.';
    }
  }

  function parseCSV(inputId, destino) {
    const input = document.getElementById(inputId);
    input.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        Papa.parse(ev.target.result, {
          header: true,
          skipEmptyLines: true,
          complete: res => {
            if (res.errors.length) {
              document.getElementById('resultado').innerHTML =
                `<div class="item">Erro ao processar ${inputId}: ${res.errors[0].message}</div>`;
              return;
            }
            const data = res.data.map(l => {
              const novo = {};
              for (const k in l) {
                novo[k.trim()] = l[k] === "NULL" ? "" : l[k];
              }
              return novo;
            });
            destino.length = 0;
            destino.push(...data);
            checkReady();
          },
          error: err => {
            document.getElementById('resultado').innerHTML =
              `<div class="item">Erro: ${err.message}</div>`;
          }
        });
      };
      reader.readAsText(file);
    });
  }

  parseCSV('csvMeta', dadosMeta);
  parseCSV('csvSerie', dadosSerie);

  function parseNum(v) {
    return parseFloat((v || '').toString().replace(',', '.').trim());
  }

  function fmt(v, dec = 2) {
    return isNaN(v) ? '' : v.toFixed(dec);
  }

  function calcularLC(id, massaKg) {
    const filtro = dadosSerie.filter(r =>
      (r.id_secagenscore || '').trim() === id &&
      r.LC_3_8 && r.DataHora
    );

    const lc = filtro.map(r => parseNum(r.LC_3_8)).sort((a, b) => a - b);
    const dif = lc.length ? lc[lc.length - 1] - lc[0] : NaN;

    const ts = filtro.map(r => new Date(r.DataHora).getTime()).filter(n => !isNaN(n)).sort((a, b) => a - b);
    const duracao = ts.length ? (ts[ts.length - 1] - ts[0]) / 36e5 : NaN;

    const ton = parseNum(massaKg) / 1000;
    const taxa = dif / (duracao * ton);

    return { dif, duracao, taxa };
  }

  document.getElementById('btnFiltrar').addEventListener('click', () => {
    const pot = document.getElementById('potenciaInput').value.trim();
    const ten = document.getElementById('tensaoInput').value.trim();
    const out = document.getElementById('resultado');

    if (!pot || !ten) {
      out.innerHTML = `<div class="item">Preenche ambos os campos.</div>`;
      return;
    }

    const encontrados = dadosMeta.filter(r =>
      (r.potencia || '').trim() === pot &&
      (r.tensao || '').trim() === ten
    );

    if (!encontrados.length) {
      out.innerHTML = `<div class="item">Nenhum transformador encontrado.</div>`;
      return;
    }

    let html = `<strong>${encontrados.length} transformador(es):</strong><br>`;
    encontrados.forEach((m, i) => {
      const id = (m.id_secagenscore || '').trim();
      const res = calcularLC(id, m.massai);
      const massaTon = parseNum(m.massai) / 1000;
      html += `
        <div class="item">
          <strong>#${i + 1} — ID:</strong> ${id}<br>
          <strong>Subprojeto:</strong> ${m.subprojecto || 'N/A'}<br>
          <strong>Massa:</strong> ${fmt(massaTon, 3)} t<br>
          <strong>Δ LC:</strong> ${fmt(res.dif, 3)}<br>
          <strong>Duração (h):</strong> ${fmt(res.duracao)}<br>
          <strong>Taxa LC:</strong> ${fmt(res.taxa)}
        </div>
      `;
    });
    out.innerHTML = html;
  });
});
</script>

</body>
</html>
