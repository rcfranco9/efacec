<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>Consulta Transformador com 2 CSV</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  #resultado {
    margin-top: 20px;
    padding: 15px;
    border: 2px solid #333;
    max-width: 600px;
    background: #f9f9f9;
  }
  input, button {
    padding: 6px 10px;
    margin: 5px 0;
  }
</style>
</head>
<body>

<h1>Consulta Transformador</h1>

<label for="csvFile1">Escolhe o primeiro ficheiro CSV:</label><br>
<input type="file" id="csvFile1" accept=".csv" /><br><br>

<label for="csvFile2">Escolhe o segundo ficheiro CSV:</label><br>
<input type="file" id="csvFile2" accept=".csv" /><br><br>

<label for="idInput">Insere o ID do transformador (id_secagenscore):</label><br>
<input type="text" id="idInput" disabled placeholder="Insere o ID" />
<button onclick="buscarDados()" disabled id="btnBuscar">Procurar</button>

<div id="resultado">Por favor, carrega os ficheiros CSV antes de procurar.</div>

<script>
  let dadosCSV1 = [];
  let dadosCSV2 = [];

  function ativarInputSePronto() {
    if (dadosCSV1.length > 0 && dadosCSV2.length > 0) {
      document.getElementById('idInput').disabled = false;
      document.getElementById('btnBuscar').disabled = false;
      document.getElementById('resultado').textContent = 'Ficheiros carregados. Insere o ID e procura.';
    }
  }

  // Função para carregar CSV
  function carregarCSV(inputId, arrayDados) {
    const fileInput = document.getElementById(inputId);
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const texto = event.target.result;

        Papa.parse(texto, {
          header: true,
          skipEmptyLines: true,
          complete: function(resultado) {
            if(inputId === 'csvFile1') {
              dadosCSV1 = resultado.data;
            } else {
              dadosCSV2 = resultado.data;
            }
            ativarInputSePronto();
          }
        });
      };
      reader.readAsText(file);
    });
  }

  carregarCSV('csvFile1', dadosCSV1);
  carregarCSV('csvFile2', dadosCSV2);

  function buscarDados() {
    const idInput = document.getElementById('idInput').value.trim();
    const resultadoDiv = document.getElementById('resultado');

    if (dadosCSV1.length === 0 || dadosCSV2.length === 0) {
      resultadoDiv.textContent = 'Carrega primeiro os dois ficheiros CSV.';
      return;
    }

    if (!idInput) {
      resultadoDiv.textContent = 'Por favor, insere um ID.';
      return;
    }

    const encontrado1 = dadosCSV1.find(linha => linha.id_secagenscore?.trim() === idInput);
    const encontrado2 = dadosCSV2.filter(linha => linha.id_secagenscore?.trim() === idInput);

    if (!encontrado1) {
      resultadoDiv.textContent = 'ID não encontrado no primeiro ficheiro.';
      return;
    }

    // Filtra valores PE_4_17 retirando zeros e valores vazios e transforma em número
    const valoresPE = encontrado2
      .map(linha => Number(linha.PE_4_17))
      .filter(val => val > 0.1);

    // Escolhe o menor valor PE_4_17 (ou undefined se não existir)
    const menorPE = valoresPE.length > 0 ? Math.min(...valoresPE) : 'Sem valor PE_4_17 válido';

   // Obter valores válidos da coluna LC_3_8 como números
const valoresLC = encontrado2
  .map(linha => Number(linha.LC_3_8))
  .filter(val => !isNaN(val)); // apenas números válidos

let diferencaLC = 'Sem valores LC_3_8 válidos';

if (valoresLC.length >= 2) {
  const valorInicial = valoresLC[0];
  const valorFinal = valoresLC[valoresLC.length - 1];
  diferencaLC = (valorFinal - valorInicial).toFixed(2); // arredonda a 2 casas decimais
}
// Obter valores válidos da coluna datahora como objetos Date
const datasValidas = encontrado2
  .map(linha => new Date(linha.datahora.replace(' ', 'T')))
  .filter(d => !isNaN(d.getTime())); // filtra datas inválidas

let duracaoHoras = 'Sem datas válidas';

const datasValidas = encontrado2
  .map(linha => {
    const raw = linha.DataHora?.trim(); // Usa o nome correto da coluna
    if (!raw) return null;
    const data = new Date(raw.replace(' ', 'T')); // Transforma em ISO
    return isNaN(data.getTime()) ? null : data;
  })
  .filter(d => d !== null);

if (datasValidas.length >= 2) {
  datasValidas.sort((a, b) => a - b);
  const inicio = datasValidas[0];
  const fim = datasValidas[datasValidas.length - 1];
  const diffMs = fim - inicio;
  duracaoHoras = (diffMs / (1000 * 60 * 60)).toFixed(2); // converte ms em horas
}


    
   
    resultadoDiv.innerHTML = `
      <h2>Resultados para ID: ${idInput}</h2>
      <p><strong>Potência:</strong> ${encontrado1.potencia || 'N/A'}</p>
      <p><strong>Tensão:</strong> ${encontrado1.tensao || 'N/A'}</p>
      <p><strong>Massat:</strong> ${encontrado1.massat || 'N/A'}</p>
      <p><strong>Massai:</strong> ${encontrado1.massai || 'N/A'}</p>
      <p><strong>Menor valor PE_4_17 (sem zeros):</strong> ${menorPE}</p>
      <p><strong>Diferença LC_3_8 (final - inicial):</strong> ${diferencaLC}</p>
      <p><strong>Duração total (horas):</strong> ${duracaoHoras}</p>


    `;
  }
</script>

</body>
</html>

</script>

</body>
</html>
