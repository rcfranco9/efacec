<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Consulta Transformador com 2 CSV</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #resultado {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #333;
      max-width: 600px;
      background: #f9f9f9;
    }
    input, button {
      padding: 6px 10px;
      margin: 5px 0;
    }
  </style>
</head>
<body>

<h1>Consulta Transformador</h1>

<label for="csvFile1">Escolhe o primeiro ficheiro CSV:</label><br>
<input type="file" id="csvFile1" accept=".csv" /><br><br>

<label for="csvFile2">Escolhe o segundo ficheiro CSV:</label><br>
<input type="file" id="csvFile2" accept=".csv" /><br><br>

<label for="idInput">Insere o ID do transformador (id_secagenscore):</label><br>
<input type="text" id="idInput" disabled placeholder="Insere o ID" />
<button onclick="buscarDados()" disabled id="btnBuscar">Procurar</button>

<div id="resultado">Por favor, carrega os ficheiros CSV antes de procurar.</div>

<script>
  let dadosCSV1 = [];
  let dadosCSV2 = [];

  // Verifica se ambos os ficheiros foram carregados
  function ativarInputSePronto() {
    if (dadosCSV1.length > 0 && dadosCSV2.length > 0) {
      document.getElementById('idInput').disabled = false;
      document.getElementById('btnBuscar').disabled = false;
      document.getElementById('resultado').textContent = 'Ficheiros carregados. Insere o ID e procura.';
    }
  }

  // Carregar CSV 1
  document.getElementById('csvFile1').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      Papa.parse(event.target.result, {
        header: true,
        skipEmptyLines: true,
        complete: function(resultado) {
          dadosCSV1 = resultado.data;
          ativarInputSePronto();
        }
      });
    };
    reader.readAsText(file);
  });

  // Carregar CSV 2
  document.getElementById('csvFile2').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      Papa.parse(event.target.result, {
        header: true,
        skipEmptyLines: true,
        complete: function(resultado) {
          dadosCSV2 = resultado.data;
          ativarInputSePronto();
        }
      });
    };
    reader.readAsText(file);
  });

  function buscarDados() {
    const idInput = document.getElementById('idInput').value.trim();
    const resultadoDiv = document.getElementById('resultado');

    if (!idInput) {
      resultadoDiv.textContent = 'Por favor, insere um ID.';
      return;
    }

    const encontrado1 = dadosCSV1.find(linha => linha.id_secagenscore?.trim() === idInput);
    const encontrados2 = dadosCSV2.filter(linha => linha.id_secagenscore?.trim() === idInput);

    if (!encontrado1) {
      resultadoDiv.textContent = 'ID não encontrado no primeiro ficheiro.';
      return;
    }

    if (encontrados2.length === 0) {
      resultadoDiv.textContent = 'ID não encontrado no segundo ficheiro.';
      return;
    }

    // menor valor PE_4_17 > 0.1
    const valoresPE = encontrados2
      .map(linha => Number(linha.PE_4_17))
      .filter(val => val > 0.1);
    const menorPE = valoresPE.length > 0 ? Math.min(...valoresPE).toFixed(3) : 'Sem valor PE_4_17 válido (> 0.1)';

    // diferença LC_3_8
    const valoresLC = encontrados2
      .map(linha => Number(linha.LC_3_8))
      .filter(val => !isNaN(val));
    const difLC = valoresLC.length >= 2 ? (valoresLC[valoresLC.length - 1] - valoresLC[0]).toFixed(3) : 'Insuficiente';

    // duração (em horas) entre primeiras e últimas DataHora
    const datas = encontrados2
      .map(linha => new Date(linha.DataHora))
      .filter(data => !isNaN(data.getTime()))
      .sort((a, b) => a - b);

    let duracaoHoras = 'Tempo inválido';
    if (datas.length >= 2) {
      const diffMs = datas[datas.length - 1] - datas[0];
      duracaoHoras = (diffMs / (1000 * 60 * 60)).toFixed(2) + ' horas';
    }

  // Calcular taxa LC normalizada
let taxaLCNormalizada = 'Indefinido';
if (difLC !== 'Sem valores válidos' && duracaoHoras > 0 && massaiToneladas > 0) {
  taxaLCNormalizada = (difLC / (duracaoHoras * massaiToneladas)).toFixed(6);
}

resultadoDiv.innerHTML = `
  <h2>Resultados para ID: ${idInput}</h2>
  <p><strong>Potência:</strong> ${encontrado1.potencia || 'N/A'}</p>
  <p><strong>Tensão:</strong> ${encontrado1.tensao || 'N/A'}</p>
  <p><strong>Massat:</strong> ${encontrado1.massat || 'N/A'}</p>
  <p><strong>Massai:</strong> ${massaiToneladas.toFixed(2)} t</p>
  <p><strong>Menor valor PE_4_17 (&gt; 0.1):</strong> ${menorPE}</p>
  <p><strong>Variação LC_3_8:</strong> ${difLC}</p>
  <p><strong>Duração do processo:</strong> ${duracaoHoras}</p>
  <p><strong>Taxa LC normalizada:</strong> ${taxaLCNormalizada}</p>
`;
  }
</script>

</body>
</html>
