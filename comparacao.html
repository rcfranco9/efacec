<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Comparação de Transformadores</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2em;
    }
    .diff-positive {
      background-color: #d4edda;
      color: #155724;
    }
    .diff-negative {
      background-color: #f8d7da;
      color: #721c24;
    }
    .diff-neutral {
      background-color: #fdfdfe;
      color: #333;
    }
    .transformador-dados {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 8px;
      background: #f9f9f9;
      width: 45%;
      display: inline-block;
      vertical-align: top;
    }
    .resultado-comparacao table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    .resultado-comparacao th,
    .resultado-comparacao td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
    }
    .resultado-comparacao th {
      background-color: #eee;
    }
  </style>
</head>
<body>

  <h1>Comparação de Transformadores</h1>
  <div id="comparacao"></div>

  <script>
    // Exemplo de dados de metadados
    const dadosMeta = [
      {
        id_secagenscore: "T01",
        marca: "Efacec",
        tipo: "Trifásico",
        massat: 5000,
        massai: 800,
        ano: 2005,
        local: "Subestação A",
        tensao: 150,
        potencia: 63000
      },
      {
        id_secagenscore: "T04",
        marca: "Siemens",
        tipo: "Trifásico",
        massat: 5200,
        massai: 850,
        ano: 2010,
        local: "Subestação B",
        tensao: 150,
        potencia: 70000
      }
    ];

    // Exemplo de dados de secagem
    const dadosSecagem = [
      {
        id_secagenscore: "T01",
        valores: [
          { tempo: 0, humidade: 5.5 },
          { tempo: 3600, humidade: 5.2 },
          { tempo: 7200, humidade: 4.9 },
          { tempo: 10800, humidade: 4.6 },
          { tempo: 14400, humidade: 4.3 },
          { tempo: 18000, humidade: 4.1 },
          { tempo: 21600, humidade: 3.9 },
          { tempo: 25200, humidade: 3.7 },
          { tempo: 28800, humidade: 3.5 },
          { tempo: 32400, humidade: 3.3 }
        ]
      },
      {
        id_secagenscore: "T04",
        valores: [
          { tempo: 0, humidade: 6.0 },
          { tempo: 3600, humidade: 5.7 },
          { tempo: 7200, humidade: 5.5 },
          { tempo: 10800, humidade: 5.3 },
          { tempo: 14400, humidade: 5.0 },
          { tempo: 18000, humidade: 4.7 },
          { tempo: 21600, humidade: 4.5 },
          { tempo: 25200, humidade: 4.3 },
          { tempo: 28800, humidade: 4.1 },
          { tempo: 32400, humidade: 3.9 }
        ]
      }
    ];

    function calcularTaxa(dadosSecagem) {
      const dadosOrdenados = dadosSecagem.valores.sort((a, b) => a.tempo - b.tempo);
      const ultimos10 = dadosOrdenados.slice(-10);
      const deltaTempo = (ultimos10[ultimos10.length - 1].tempo - ultimos10[0].tempo) / 3600; // s → h
      const deltaHumidade = ultimos10[0].humidade - ultimos10[ultimos10.length - 1].humidade;

      const taxa = (deltaHumidade / deltaTempo) / dadosSecagem.massai;
      return { taxa: taxa.toFixed(3) };
    }

    function mostrarDadosMeta(meta) {
      if (!meta) return '<p>Dados não encontrados.</p>';
      const camposMostrar = ['id_secagenscore','marca','tipo','massat','massai','ano','local','tensao','potencia'];

      let html = '<div class="transformador-dados">';
      html += `<h3>Transformador ${meta.id_secagenscore}</h3>`;
      camposMostrar.forEach(campo => {
        if(meta[campo]) {
          html += `<p><strong>${campo.charAt(0).toUpperCase() + campo.slice(1)}:</strong> ${meta[campo]}</p>`;
        }
      });
      html += '</div>';
      return html;
    }

    function compararTransformadores(id1, id2, dadosMeta, dadosSecagem) {
      const m1 = dadosMeta.find(d => d.id_secagenscore === id1);
      const m2 = dadosMeta.find(d => d.id_secagenscore === id2);
      const s1 = dadosSecagem.find(d => d.id_secagenscore === id1);
      const s2 = dadosSecagem.find(d => d.id_secagenscore === id2);

      // Junta massa isolante aos dados de secagem (podes mudar isto se vier separado)
      s1.massai = m1.massai;
      s2.massai = m2.massai;

      const t1 = calcularTaxa(s1);
      const t2 = calcularTaxa(s2);

      const camposComparar = [
        { nome: 'Marca', chave: 'marca' },
        { nome: 'Tipo', chave: 'tipo' },
        { nome: 'Ano', chave: 'ano' },
        { nome: 'Local', chave: 'local' },
        { nome: 'Massa total (ton)', chave: 'massat' },
        { nome: 'Massa isolante (ton)', chave: 'massai' },
        { nome: 'Tensão (kV)', chave: 'tensao' },
        { nome: 'Potência (kVA)', chave: 'potencia' }
      ];

      let html = '<div class="resultado-comparacao">';
      html += mostrarDadosMeta(m1);
      html += mostrarDadosMeta(m2);

      html += '<table>';
      html += '<thead><tr><th>Campo</th><th>Transformador 1</th><th>Transformador 2</th><th>Diferença</th></tr></thead>';
      html += '<tbody>';

      camposComparar.forEach(campo => {
        const val1 = m1[campo.chave];
        const val2 = m2[campo.chave];
        let diff = '';

        if (!isNaN(parseFloat(val1)) && !isNaN(parseFloat(val2))) {
          const dif = parseFloat(val1) - parseFloat(val2);
          diff = `<td class="${dif > 0 ? 'diff-positive' : dif < 0 ? 'diff-negative' : 'diff-neutral'}">${dif.toFixed(2)}</td>`;
        } else {
          diff = `<td class="diff-neutral">${val1 === val2 ? 'Igual' : '—'}</td>`;
        }

        html += `
          <tr>
            <td>${campo.nome}</td>
            <td>${val1}</td>
            <td>${val2}</td>
            ${diff}
          </tr>
        `;
      });

      const taxaDiff = (t1.taxa - t2.taxa).toFixed(3);
      html += `
        <tr>
          <td>Taxa de Secagem (1/h.ton)</td>
          <td>${t1.taxa}</td>
          <td>${t2.taxa}</td>
          <td class="${taxaDiff > 0 ? 'diff-positive' : taxaDiff < 0 ? 'diff-negative' : 'diff-neutral'}">${taxaDiff}</td>
        </tr>
      `;

      html += '</tbody></table></div>';
      return html;
    }

    // Invocar e mostrar resultado no ecrã
    const htmlComparacao = compararTransformadores("T01", "T04", dadosMeta, dadosSecagem);
    document.getElementById("comparacao").innerHTML = htmlComparacao;
  </script>

</body>
</html>
