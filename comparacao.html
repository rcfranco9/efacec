<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>Comparar Transformadores</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
      Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    margin: 40px auto;
    max-width: 650px;
    background: #f5f7fa;
    color: #333;
    padding: 20px 25px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
  }

  h1 {
    text-align: center;
    font-weight: 600;
    margin-bottom: 30px;
    color: #222;
  }

  label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 600;
    color: #555;
  }

  input[type="text"],
  input[type="file"] {
    width: 100%;
    padding: 12px 15px;
    font-size: 15px;
    border: 1.8px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
  }

  input[type="text"]:focus,
  input[type="file"]:focus {
    border-color: #007bff;
    outline: none;
  }

  button {
    margin-top: 22px;
    width: 100%;
    background-color: #007bff;
    border: none;
    padding: 14px 0;
    font-size: 16px;
    font-weight: 600;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }

  button:hover:not(:disabled) {
    background-color: #0056b3;
  }

  button:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }

  #resultado {
    margin-top: 30px;
    background: white;
    border-radius: 10px;
    padding: 20px 25px;
    box-shadow: 0 4px 15px rgb(0 0 0 / 0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 15px;
  }

  th, td {
    padding: 12px 15px;
    border-bottom: 1px solid #ddd;
    text-align: center;
  }

  th {
    background-color: #f0f4ff;
    color: #004085;
    font-weight: 700;
  }

  tbody tr:hover {
    background-color: #f9faff;
  }

  /* Cor para diferença positiva (ID1 maior que ID2) */
  .diff-positive {
    color: #198754; /* verde */
    font-weight: 600;
  }

  /* Cor para diferença negativa (ID1 menor que ID2) */
  .diff-negative {
    color: #dc3545; /* vermelho */
    font-weight: 600;
  }

  /* Cor neutra para diferença zero ou n/a */
  .diff-neutral {
    color: #6c757d;
    font-weight: 500;
  }

  /* Mensagem de erro ou aviso */
  .msg {
    padding: 15px;
    background: #ffe6e6;
    border-radius: 6px;
    border: 1px solid #dc3545;
    color: #b02a37;
    font-weight: 600;
    margin-top: 25px;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Comparar Transformadores</h1>

<label for="csvFile">Escolhe o ficheiro CSV:</label>
<input type="file" id="csvFile" accept=".csv" />

<label for="id1Input">ID Transformador 1 (id_secagenscore):</label>
<input type="text" id="id1Input" disabled placeholder="Insere o primeiro ID" />

<label for="id2Input">ID Transformador 2 (id_secagenscore):</label>
<input type="text" id="id2Input" disabled placeholder="Insere o segundo ID" />

<button id="btnComparar" disabled>Comparar</button>

<div id="resultado">Por favor, carrega o ficheiro CSV antes de comparar.</div>

<script>
  let dadosCSV = [];

  // Carregar CSV
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      Papa.parse(event.target.result, {
        header: true,
        skipEmptyLines: true,
        complete: function(res) {
          dadosCSV = res.data;
          console.log("CSV carregado:", dadosCSV);
          document.getElementById('resultado').textContent = 'CSV carregado. Insere os dois IDs para comparar.';
          document.getElementById('id1Input').disabled = false;
          document.getElementById('id2Input').disabled = false;
          document.getElementById('btnComparar').disabled = false;
        },
        error: function(err) {
          document.getElementById('resultado').innerHTML = `<div class="msg">Erro ao ler CSV: ${err.message}</div>`;
        }
      });
    };
    reader.readAsText(file);
  });

  function formataNumero(val) {
    if (!val) return 'N/A';
    const num = parseFloat(val.toString().replace(',', '.').trim());
    if (isNaN(num)) return val.trim();
    return num.toFixed(2);
  }

  // Calcula a diferença e devolve classe para cor
  function classificaDiferenca(diff) {
    if (diff === 'N/A' || diff === 0) return 'diff-neutral';
    return diff > 0 ? 'diff-positive' : 'diff-negative';
  }

  document.getElementById('btnComparar').addEventListener('click', function() {
    const id1 = document.getElementById('id1Input').value.trim();
    const id2 = document.getElementById('id2Input').value.trim();
    const resultadoDiv = document.getElementById('resultado');

    if (!id1 || !id2) {
      resultadoDiv.innerHTML = `<div class="msg">Por favor, insere os dois IDs.</div>`;
      return;
    }

    const d1 = dadosCSV.find(item => (item.id_secagenscore || '').trim() === id1);
    const d2 = dadosCSV.find(item => (item.id_secagenscore || '').trim() === id2);

    if (!d1 || !d2) {
      resultadoDiv.innerHTML = `<div class="msg">Não encontrei um ou ambos os IDs no ficheiro.</div>`;
      return;
    }

    const campos = ['potencia', 'tensao', 'massat', 'massai'];

    let html = `<h2>Comparação entre ID ${id1} e ID ${id2}</h2>`;
    html += `<table>
      <thead>
        <tr>
          <th>Parâmetro</th>
          <th>ID ${id1}</th>
          <th>ID ${id2}</th>
          <th>Diferença (ID1 - ID2)</th>
        </tr>
      </thead>
      <tbody>`;

    campos.forEach(campo => {
      const val1 = d1[campo] || 'N/A';
      const val2 = d2[campo] || 'N/A';

      const num1 = parseFloat(val1.toString().replace(',', '.').trim());
      const num2 = parseFloat(val2.toString().replace(',', '.').trim());

      let diff = 'N/A';
      if (!isNaN(num1) && !isNaN(num2)) {
        diff = +(num1 - num2).toFixed(2);
      }

      html += `<tr>
        <td>${campo.charAt(0).toUpperCase() + campo.slice(1)}</td>
        <td>${formataNumero(val1)}</td>
        <td>${formataNumero(val2)}</td>
        <td class="${classificaDiferenca(diff)}">${diff}</td>
      </tr>`;
    });

    html += '</tbody></table>';
    resultadoDiv.innerHTML = html;
  });
</script>

</body>
</html>
