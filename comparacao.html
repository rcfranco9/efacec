<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Comparar Transformadores</title>
</head>
<body>
  <h2>Comparar Transformadores</h2>

  <input type="file" id="csvFile" accept=".csv"><br><br>

  <label>ID 1: <input type="text" id="id1"></label><br><br>
  <label>ID 2: <input type="text" id="id2"></label><br><br>

  <button id="botaoComparar">Comparar</button>

  <p id="erro" style="color: red;"></p>
  <div id="resultado"></div>

  <!-- SÓ AQUI ENTRA O SCRIPT: -->
  <script>
    document.getElementById("botaoComparar").addEventListener("click", comparar);

    function comparar() {
      const fileInput = document.getElementById('csvFile');
      const id1 = document.getElementById('id1').value.trim().toLowerCase();
      const id2 = document.getElementById('id2').value.trim().toLowerCase();
      const erro = document.getElementById('erro');
      const resultado = document.getElementById('resultado');

      erro.textContent = '';
      resultado.innerHTML = '';

      if (!fileInput.files.length) {
        erro.textContent = 'Carrega o ficheiro CSV.';
        return;
      }

      const ficheiro = fileInput.files[0];
      const leitor = new FileReader();

      leitor.onload = function(e) {
        const texto = e.target.result;
        const linhas = texto.split('\n').filter(l => l.trim() !== '');
        const cabecalho = linhas[0].split(';').map(h => h.trim().toLowerCase());

        const dados = linhas.slice(1).map(linha => {
          const valores = linha.split(';');
          const obj = {};
          cabecalho.forEach((h, i) => obj[h] = valores[i] ? valores[i].trim() : '');
          return obj;
        });

        const colId = 'id_secagenscore';

        const d1 = dados.find(d => d[colId]?.toLowerCase() === id1);
        const d2 = dados.find(d => d[colId]?.toLowerCase() === id2);

        if (!d1 || !d2) {
          erro.textContent = 'Não encontrei um ou ambos os IDs no ficheiro.';
          return;
        }

        const campos = ['potencia', 'tensao', 'massat', 'massai'];
        let html = '<table border="1" cellpadding="5"><tr><th>Parâmetro</th><th>ID 1</th><th>ID 2</th><th>Diferença</th></tr>';

        campos.forEach(campo => {
          const v1 = parseFloat((d1[campo] || '0').replace(',', '.'));
          const v2 = parseFloat((d2[campo] || '0').replace(',', '.'));
          const diff = (!isNaN(v1) && !isNaN(v2)) ? (v1 - v2).toFixed(2) : 'N/A';
          html += `<tr><td>${campo}</td><td>${d1[campo]}</td><td>${d2[campo]}</td><td>${diff}</td></tr>`;
        });

        html += '</table>';
        resultado.innerHTML = html;
      };

      leitor.readAsText(ficheiro);
    }
  </script>
</body>
</html>
